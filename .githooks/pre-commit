#!/usr/bin/env sh

# Get all changed PHP files once.
PHP_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.php$" || true)

# Skip if no PHP files are changed.
if [ -n "$PHP_FILES" ]; then
  # First sort PHP imports
  for file in $PHP_FILES; do
    node bin/precommit/sort-php-imports.js "$file"
  done

  # Then check for unused imports.
  UNUSED_IMPORTS=0
  for file in $PHP_FILES; do
    if ! node bin/precommit/check-unused-imports.js "$file"; then
      UNUSED_IMPORTS=1
    fi
  done

  # Exit if unused imports were found.
  if [ $UNUSED_IMPORTS -eq 1 ]; then
    exit 1
  fi

  # Run PHP Code Sniffer on all changed PHP files at once.
  echo "$PHP_FILES" | xargs composer lint:fix > /dev/null 2>&1 || { echo "PHP formatting failed"; exit 1; }
fi

# Run the WordPress formatter without showing all file output.
npm run format > /dev/null 2>&1 || { echo "JavaScript formatting failed"; exit 1; }

# Make sure git is aware of all the changes made by the formatters.
git update-index --again
