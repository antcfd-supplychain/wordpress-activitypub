import{getConfig as t,getContext as e,getElement as o,store as n,withScope as a}from"@wordpress/interactivity";const{apiFetch:c}=window.wp;!function(){const{actions:t,callbacks:a}=n("activitypub/reactions",{actions:{openModal(t){const o=e();o.modal.isOpen=!0,o.modal.isCompact?setTimeout(a.positionModal,0):setTimeout(()=>{const t=document.getElementById(o.blockId);if(t){const e=t.querySelector(".activitypub-modal__frame");e&&a.trapFocus(e)}},50),"function"==typeof a.onModalOpen&&a.onModalOpen(t)},closeModal(t){const n=e();n.modal.isOpen=!1;const c=o();if("actions.toggleModal"===c.ref.dataset["wpOn-Click"])c.ref.focus();else{const t=document.getElementById(n.blockId);if(t){const e=t.querySelector('[data-wp-on--click="actions.toggleModal"], [data-wp-on-async--click="actions.toggleModal"]');e&&e.focus()}}"function"==typeof a.onModalClose&&a.onModalClose(t)},toggleModal(o){const{modal:n}=e();n.isOpen?t.closeModal(o):t.openModal(o)}},callbacks:{_abortController:null,handleModalEffects(){const{modal:t}=e();if(t.isOpen&&!t.isCompact?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),a._abortController&&(a._abortController.abort(),a._abortController=null),t.isOpen){a._abortController=new AbortController;const{signal:t}=a._abortController;document.addEventListener("keydown",a.documentKeydown,{signal:t}),document.addEventListener("click",a.documentClick,{signal:t})}},documentKeydown(o){const{modal:n}=e();n.isOpen&&"Escape"===o.key&&t.closeModal()},documentClick(o){const{blockId:n,modal:a}=e();if(!a.isOpen)return;const c=document.getElementById(n);if(!c)return;const l=c.querySelector('.wp-element-button[data-wp-on--click="actions.toggleModal"]');if(l&&(l===o.target||l.contains(o.target)))return;const s=c.querySelector(".activitypub-modal__frame");s&&!s.contains(o.target)&&t.closeModal()},positionModal(){const{blockId:t}=e(),n=document.getElementById(t);if(!n)return;const a=n.querySelector(".activitypub-modal__overlay");if(!a)return;a.style.top="",a.style.left="",a.style.right="",a.style.bottom="";const c=o().ref.getBoundingClientRect(),l=window.innerWidth,s=n.getBoundingClientRect();let i={top:c.bottom-s.top+8+"px",left:c.left-s.left-2+"px"};l-c.right<250&&(i.left="auto",i.right=s.right-c.right+"px"),Object.assign(a.style,i)},trapFocus(t){const e=t.querySelectorAll('a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]):not([readonly]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])'),o=e[0],n=e[e.length-1];o&&o.classList.contains("activitypub-modal__close")&&e.length>1?e[1].focus():o.focus(),t.addEventListener("keydown",function(t){"Tab"!==t.key&&9!==t.keyCode||(t.shiftKey?document.activeElement===o&&(n.focus(),t.preventDefault()):document.activeElement===n&&(o.focus(),t.preventDefault()))})}}})}();const{callbacks:l,state:s}=n("activitypub/reactions",{actions:{async fetchReactions(){const o=e(),{namespace:n}=t();if(o.postId)try{o.reactions=await c({path:`/${n}/posts/${o.postId}/reactions`})}catch(t){console.error("Error fetching reactions:",t)}}},callbacks:{initReactions(){const t=new ResizeObserver(a(l.calculateVisibleAvatars));return o().ref.querySelectorAll(".reaction-group").forEach(e=>{t.observe(e)}),()=>{t.disconnect()}},calculateVisibleAvatars(){const{postId:t}=e();(s.reactions&&s.reactions[t]?Object.keys(s.reactions[t]):[]).forEach(e=>{s.reactions?.[t][e]?.items?.length&&o().ref.querySelectorAll(`.reaction-group[data-reaction-type="${e}"]`).forEach(o=>{const n=o.querySelector(".reaction-label").offsetWidth||0,a=o.offsetWidth-n-12;let c=1;a>32&&(c+=Math.floor((a-32)/22));const l=s.reactions[t][e].items,i=Math.min(c,l.length),r=o.querySelector(".reaction-avatars");r&&r.querySelectorAll("li").forEach((t,e)=>{e<i?t.removeAttribute("hidden"):t.setAttribute("hidden","hidden")})})})},setDefaultAvatar(e){e.target.src=t().defaultAvatarUrl},onModalOpen(){const t=e(),n=o().ref.dataset.reactionType;t.modal.items=s.reactions[t.postId][n].items}}});